<script type="text/javascript">
    RED.nodes.registerType('ngrok', {
        category: 'network',
        color: '#008080',
        defaults: {
            buttonState: { value: false },
            port: { value: "" },
            portType: { value: "num" },
            creds: { value: "", type: "ngrokauth" },
            region: { value: 'us' },
            regionType: { value: 'us' },
            proto: { value: 'http' },
            protoType: { value: 'http' },
            bind_tls: { value: "https" },
            bind_tlsType: { value: "https" },
            subdomain: { value: "" },
            subdomainType: { value: "none" },
            auth: { value: "" },
            authType: { value: "str" },
            hostHeader: { value: "" },
            hostHeaderType: { value: "none" },
            name: { value: "" },
            inputtype: { value: "port" },
            inputs: { value: "" }
        },
        inputs: 1,
        outputs: 1,
        icon: "white-globe.png",
        label: function () {
            return this.name || "ngrok";
        },
        oneditprepare: function () {
            debugger
            var makeTypedInputOpt = function (label, value) {
                return {
                    value: value,
                    label: label,
                    hasValue: false
                }
            }
            $("#node-input-region").typedInput({
                default: "us",
                types: [
                    makeTypedInputOpt("US", "us"),
                    makeTypedInputOpt("Europe", "eu"),
                    makeTypedInputOpt("Asia/Pacific", "ap"),
                    makeTypedInputOpt("Australia", "au"),
                    makeTypedInputOpt("South America", "sa"),
                    makeTypedInputOpt("Japan", "jp"),
                    makeTypedInputOpt("India", "in"),
                    , 'msg', 'flow', 'global', 'str', 'env'
                ],
                typeField: $("#node-input-regionType"),
            })
            $("#node-input-proto").typedInput({
                default: "http",
                types: [
                    makeTypedInputOpt("HTTP", "http"),
                    makeTypedInputOpt("TCP", "tcp"),
                    , 'msg', 'flow', 'global', 'env'
                ],
                typeField: $("#node-input-protoType"),
            })
            $("#node-input-port").typedInput({
                default: "num",
                types: ['num', 'msg', 'flow', 'global', 'env'
                ],
                typeField: $("#node-input-portType"),
            })
            $("#node-input-subdomain").typedInput({
                default: "none",
                types: [makeTypedInputOpt("None", "none"), 'str', 'msg', 'flow', 'global', 'env'
                ],
                typeField: $("#node-input-subdomainType"),
            })
            $("#node-input-bind_tls").typedInput({
                default: "https",
                types: [
                    makeTypedInputOpt("HTTPS", "https"),
                    makeTypedInputOpt("HTTP", "http"),
                    makeTypedInputOpt("HTTP & HTTPS", "both"),
                    'msg', 'flow', 'global', 'env'
                ],
                typeField: $("#node-input-bind_tlsType"),
            })
            $("#node-input-auth").typedInput({
                default: "str",
                types: [makeTypedInputOpt("None", "none"), 'str', 'msg', 'flow', 'global', 'env'
                ],
                typeField: $("#node-input-authType"),
            })
            $("#node-input-hostHeader").typedInput({
                default: "none",
                types: [makeTypedInputOpt("None", "none"), 'str', 'msg', 'flow', 'global', 'env'
                ],
                typeField: $("#node-input-hostHeader"),
            })
        },
        oneditsave: function () {
            this.inputs.value = $("#node-input-inputs").val()
        },
        button: {
            visible: function () {
                if (this.inputtype == 'button') {
                    return true
                } else {
                    return false
                }
            },
            toggle: "buttonState",
            onclick: function () {
                var node = this;
                $.ajax({
                    url: "ngrokInject/" + this.id,
                    type: "POST",
                    data: { "on": this.buttonState },
                    success: function (resp) {
                        RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject" });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                        } else {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                        }
                    }
                });
            }
        }
    });
</script>

<script type="text/html" data-template-name="ngrok">
    <div class="form-row">
        <label for="node-config-input-privatekey">Authtoken</label>
        <input type="text" id="node-input-creds" >
    </div>

    <div class="form-row">
        <label for="node-input-port">Port</label>
        <input type="hidden" id="node-input-portType">
        <input type="text" id="node-input-port" placeholder="node-red current port">
    </div>

    <div class="form-row">
        <label for="node-input-region">Region</label>
        <input type="hidden" id="node-input-regionType">
        <input type="text" id="node-input-region" placeholder="region">
    </div>

    <div class="form-row">
        <label for="node-input-proto">Protocol</label>
        <input type="hidden" id="node-input-protoType">
        <input type="text" id="node-input-proto" placeholder="Protocol">
    </div>

    <div id="bind_tls" class="form-row">
        <label for="node-input-bind_tls">Binding</label>
        <input type="hidden" id="node-input-bind_tlsType">
        <input type="text" id="node-input-bind_tls" placeholder="https/http/both">
    </div>

    <div id="subdomain" class="form-row">
        <label for="node-input-subdomain">Subdomain</label>
        <input type="hidden" id="node-input-subdomainType">
        <input type="text" id="node-input-subdomain" placeholder="Name">
    </div>

    <div id="auth" class="form-row">
        <label for="node-input-auth">Auth</label>
        <input type="hidden" id="node-input-authType">
        <input type="text" id="node-input-auth" placeholder="username:password">
    </div>

    <div id="auth" class="form-row">
        <label for="node-input-hostHeader">Host header</label>
        <input type="hidden" id="node-input-hostHeaderType">
        <input type="text" id="node-input-hostHeader" placeholder="localhost:port">
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="ngrok">
    </div>

    <div class="form-row">
        <label for="node-input-inputtype">Input Type</label>
        <select type="text" id="node-input-inputtype" style="width:70%;" onchange="toggleInputType(this.value)">
            <option value="button">Button</option>
            <option value="port">Input Port</option>
        </select>
    <input type='hidden' id="node-input-inputs">
    </div>
</script>



<script>
  function toggleProtocol(proto){
    if (proto == 'http'){
      document.getElementById("subdomain").style.display = "block";
      document.getElementById("auth").style.display = "block";
      document.getElementById("bind_tls").style.display = "block";
    }
    else if (proto == 'tcp'){
      document.getElementById("subdomain").style.display = "none";
      document.getElementById("auth").style.display = "none";
      document.getElementById("bind_tls").style.display = "none";
    }
  };
  function toggleInputType(v){
    if (v == 'button') {
        $("#node-input-inputs").val(0)
    } else if (v == 'port') {
        $("#node-input-inputs").val(1)
    }    
  }
</script>

<script type="text/x-red" data-help-name="ngrok">
    <p>A node that wraps the ngrok controller and also adds the ngrok binary.</p>
    
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt><span class="property-type">object</span></dt>
        <dd> <code>msg.payload</code> is either <code>on</code> or <code>off</code> to start/stop the tunnel</dd>
    </dl>
     <h3>Outputs</h3>
     <dl class="message-properties">
         <dt><span class="property-type">object</span></dt>
         <dd> <code>msg.payload</code> will contain the ngrok public url that is established or null if the tunnel was stopped</dd>
     </dl>

    <h3>Dashboard</h3>
    <p>Open up your ngrok dashboard at <a href="http://127.0.0.1:4040">http://127.0.0.1:4040</a>.
    <br> It allows you to see the status of your tunnel, the requests made through it and the responses sent from your application. 
    <br>You can also replay requests that came through the ngrok tunnel directly from the dashboard.
    </p>
     
    
</script>


<script type="text/javascript">
    RED.nodes.registerType('ngrokauth',{
        category: 'config',
        credentials: {
          authtoken: {}
        },
        defaults :{
            name: {}
        },
        label: function() {
            return this.name || "authtoken";
        }
    });
</script>

<script type="text/html" data-template-name="ngrokauth">
  <div class="form-row">
      <label for="node-config-input-authtoken">authtoken</label>
      <input type="text" id="node-config-input-authtoken" placeholder="token">
  </div>
  <div class="form-row">
    <label for="node-config-input-name">Name</label>
    <input type="text" id="node-config-input-name" placeholder="name">
  </div>

</script>

<script type="text/html" data-help-name="ngrokauth">
   <p>Ngrok authtoken </p>
   <h3>Details</h3>
   <p> You can optionally set an authtoken obtained from ngrok.com, this is required for accesspaid features such as reserved names</p>
</script>
